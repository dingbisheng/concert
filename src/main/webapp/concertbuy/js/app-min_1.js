var curDate;var dp=null;function initPerformCalendar(){if($('.m-product .m-choose-date .lst .itm:not(".itm-more")').size()<7){$('.m-product .m-choose-picker').hide();$('.m-product .m-choose-date').show();return}var firstperformid=$("#priceList").attr("data-performId");var firstperformdate=$("div.m-choose.m-choose-date .lst .itm[data-performId="+firstperformid+"]").attr("data-performTime").split(' ')[0].replace(/\-/g,'/');curDate=datepicker.date2str(new Date(firstperformdate));initialize(findShowDate())}var message={cancel:'是否要取消当前的选择？'};function findShowDate(){var $date=$('.m-choose-date');var $itms=$date.find('[data-performTime]');var ret={'data':[]};$itms.each(function(index,item){var performtime=$(item).attr('data-performTime');var date='';date=performtime.replace(/-/g,'/').split(' ')[0];var title=$(item).find('a').text();ret.data.push({date:date,title:title,buycount:$(item).attr('data-buyCount'),performid:$(item).attr('data-performId'),performtime:performtime})});return ret}function initialize(res){dateData=res.data;dp=datepicker.set({element:$('.m-datepicker'),view:'month',data:dateData,utc:false,swipe:false,showPrevMonth:false,showNextMonth:false,curDate:new Date(curDate),onReady:function(date){var $itm=this.element.find('[data-datetime="'+date+'"]');if($itm.hasClass('z-dis')||$itm.hasClass('z-free')){$itm=findNearShow(this.element,date);if($itm.data('datetime')!==curDate){curDate=$itm.data('datetime')}}onDateChange(this.element,$itm,curDate);dp.render();$itm=this.element.find('[data-datetime="'+curDate+'"]');$itm.addClass('z-sel');renderYearMonth(this.element,this.data);switchTab(this.element,curDate);bind(this.element);showNowDate(curDate,this.data);$('.m-product .m-choose-date').show();},onClick:function(date,item){var $itm=$(item);if($(item).hasClass('z-dis')||$(item).hasClass('z-free'))return;if(date===curDate){if($itm.hasClass('z-sel')){if($('.m-cart').find('.itm').size()&&confirm(message.cancel)){cancelChoose();$itm.removeClass('z-sel')}else{return false}}else{$itm.addClass('z-sel')}}else{if($(item).hasClass('z-show')&&$('.m-cart').find('.itm').size()){if(!confirm(message.cancel)){return false}}onDateChange(this.element,$(item),date);cancelChoose();showNowDate(curDate,this.data)}}});dp.start()}function showNowDate(date,data){var res=[];$.each(data,function(index,item){if(item.date.replace(/-/g,'/')===date){res.push(item)}});var $chooseDate=$('.m-choose-date');var $chooseDateItms=$chooseDate.find('[data-performTime]');$chooseDateItms.remove();var html='';var tmpl='<li class="itm j_more" data-performId="{{ performId }}" data-performTime="{{ performtime }}" data-buyCount="{{ buycount }}"><a href="javascript:;">{{ title }}</a></li>';$.each(res,function(index,item){var json=item;json.date=json.date.replace(/\//g,'-');json.performtime=json.performtime.replace(/\//g,'-');json.title=json.title.replace(/\//g,'-');html+=format(tmpl,json)});$chooseDate.find('.lst').prepend(html);$('.m-choose-date .lst .itm').first().find('a').click()}function onDateChange(context,item,date){curDate=date;dp.set({curDate:new Date(curDate)});context.find('.datebox .itm').removeClass('z-sel');item.addClass('z-sel')}function cancelChoose(){$('.m-cart').find('.itm').remove();$('.m-choose-date').find('.itm').removeClass('itm-sel');$('.m-choose-price').find('.itm').removeClass('itm-sel')}function bind(element){element.on('click','.u-btn-prev',function(){if($(this).hasClass('z-dis'))return;switchTab(element,'prev')});element.on('click','.u-btn-next',function(){if($(this).hasClass('z-dis'))return;switchTab(element,'next')});element.on('click','.weekbox .itm',function(){$(this).addClass('z-crt').siblings().removeClass('z-crt');var nowDate=$(this).data('datetime').split('/').splice(0,2).concat("1").join('/');dp.set({curDate:new Date(nowDate)});dp.render();var $itm=element.find('[data-datetime="'+curDate+'"]');element.find('.month .itm').removeClass('z-sel');if(!$itm.hasClass('z-dis'))$itm.addClass('z-sel');renderYearMonth(dp.opts.element,dp.opts.data,nowDate);switchTab(dp.opts.element,nowDate)})}function findNearShow(context,date){var $collect=context.find('.datebox .itm');var $itm=$collect.filter('[data-datetime="'+date+'"]');var $ret=null;var prev=-1;var next=-1;var count=0;var middle=-1;$collect.each(function(index,item){if($itm.get(0)===item){middle=index;return false}});if(middle>-1){count=middle;while(count--){if($collect.eq(count).hasClass('z-show')){prev=count;break}}count=middle;while(count++<$collect.size()){if($collect.eq(count).hasClass('z-show')){next=count;break}}}if(prev!==-1&&next===-1){$ret=$collect.eq(prev)}if(prev===-1&&next!==-1){$ret=$collect.eq(next)}if(prev!==-1&&next!==-1){if(Math.abs(middle-prev)<Math.abs(middle-next)){$ret=$collect.eq(prev)}else{$ret=$collect.eq(next)}}return $ret}function switchTab(context,direct){var $prev=context.find('.u-btn-prev');var $next=context.find('.u-btn-next');var $lst=context.find('.weekbox .lst');var left=0;if(direct==='prev'){left=$lst.position().left+$lst.parent().width()}else if(direct==='next'){left=$lst.position().left-$lst.parent().width()}else{$lst.find('.itm').each(function(index,item){if(compareYearMonth($(item).data('datetime'),direct)){var n=~~($(item).position().left/$lst.parent().width());left=-n*$lst.parent().width();return false}})}if(left>0||left===0){$prev.addClass('z-dis')}else{$prev.removeClass('z-dis')}if(Math.abs(left-Math.ceil($lst.width()/$lst.parent().width()))>$lst.width()-$lst.parent().width()){$next.addClass('z-dis')}else{$next.removeClass('z-dis')}$lst.css({left:left})}function compareYearMonth(date1,date2){return datepicker.formatDateStr(date1).split('/').splice(0,2).join('/')===datepicker.formatDateStr(date2).split('/').splice(0,2).join('/')}function renderYearMonth(context,data,cur){var weekbox=context.find('.weekbox .box');var max_month=5;data=sortData(data);var html='';var tmplPrev='<a href="javascript:;" class="u-btn u-btn-prev">上翻</a>';var tmplNext='<a href="javascript:;" class="u-btn u-btn-next">下翻</a>';var tmplMonthBox='<div class="monthpicker{{ flip }}">{{ prev }}<div class="box">{{ lst }}</div>{{ next }}</div>';var tmplMonthLst='<ul class="lst">{{ lst }}</ul>';var tmplMonthItm='<li class="itm{{ crt }}" data-datetime="{{ datetime }}"{{ style }}><span class="txt">{{ date }}</span><div class="ico"></div></li>';for(var i=0,len=data.length;i<len;i++){html+=format(tmplMonthItm,{crt:compareYearMonth(cur||curDate,data[i])?' z-crt':'',date:data[i].replace(/\//g,'-').match(/\d{4}-\d{2}/)[0],datetime:data[i],style:data.length<max_month?('style="width: '+(100/data.length).toFixed(6)+'%;"'):''})}tmplMonthLst=format(tmplMonthLst,{lst:html});tmplMonthBox=format(tmplMonthBox,{prev:data.length<max_month?'':tmplPrev,next:data.length<max_month?'':tmplNext,flip:data.length<max_month?'':' monthpicker-more',lst:tmplMonthLst});weekbox.html(tmplMonthBox);if(data.length>max_month||data.length===max_month)weekbox.find('.lst').width(weekbox.find('.itm').outerWidth(true)*weekbox.find('.itm').size());weekbox.find('.itm').first().addClass('itm-first')}function sortData(data){var dict={};var ret=[];for(var i=0,len=data.length;i<len;i++){var month=data[i].date.match(/\d{4}\D\d{2}/)[0];if(!dict[month]){dict[month]=data[i].date;ret.push(month+'/01')}}ret.sort(function(a,b){var t1=new Date(a).getTime();var t2=new Date(b).getTime();return t1-t2});return ret}function format(str,json){for(var i in json){var re=new RegExp('{{\\s*'+i+'\\s*}}','ig');str=str.replace(re,json[i])}return str};